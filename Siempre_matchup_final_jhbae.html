
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Siempre 대진표 생성</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 5px; }
    textarea { width: 100%; height: 300px; margin-top: 20px; white-space: pre-wrap; }
    .player-item, .match-item { margin-bottom: 5px; }
    .btn-sm { font-size: 0.8em; padding: 2px 6px; }
  </style>
</head>
<body>
  <h2>🏸 Siempre 대진표 생성</h2>

  <label>이름: <input type="text" id="nameInput" /></label>
  <label>실력:
    <select id="skillInput">
      <option value="0">0 (초심)</option>
      <option value="1" selected>1 (E)</option>
      <option value="2">2 (D)</option>
      <option value="3">3 (C)</option>
      <option value="4">4 (B)</option>
      <option value="5">5 (A)</option>
    </select>
  </label>
  <label>성별:
    <select id="genderInput">
      <option value="남">남</option>
      <option value="여">여</option>
    </select>
  </label>
  <button onclick="addPlayer()">추가</button>

  <div id="playerList"></div>

  <label>게임 수 제한 (인당): <input type="number" id="maxGames" value="3" min="1" /></label>
  <label>최대 실력차: <input type="number" id="maxDiff" value="1" min="0" /></label>
  <br>
  <button onclick="generateMatches()">대진표 생성</button>
  <button onclick="clearMatches()">모든 경기 삭제</button>
  <button onclick="resetAll()">🔄 모든 데이터 초기화</button>


  <div id="matchList"></div>
  <textarea id="result" readonly></textarea>

<script>
let players = [];
let matches = [];
let finalizedMatches = [];
let playerGameCounts = {};

function saveToLocalStorage() {
  localStorage.setItem("players", JSON.stringify(players));
  localStorage.setItem("playerGameCounts", JSON.stringify(playerGameCounts));
  localStorage.setItem("finalizedMatches", JSON.stringify(finalizedMatches));
}

function loadFromLocalStorage() {
  const p = localStorage.getItem("players");
  const c = localStorage.getItem("playerGameCounts");
  const m = localStorage.getItem("finalizedMatches");
  if (p) players = JSON.parse(p);
  if (c) playerGameCounts = JSON.parse(c);
  if (m) finalizedMatches = JSON.parse(m);
}

function skillToGrade(score) {
  return {0: "초심", 1: "E", 2: "D", 3: "C", 4: "B", 5: "A"}[score] || "?";
}

function addPlayer() {
  const name = document.getElementById("nameInput").value.trim();
  const skill = parseInt(document.getElementById("skillInput").value);
  const gender = document.getElementById("genderInput").value;
  if (!name || isNaN(skill)) {
    alert("입력을 확인하세요.");
    return;
  }
  players.push({ name, skill, gender });
  playerGameCounts[name] = 0;
  document.getElementById("nameInput").value = "";
  updatePlayerList();
saveToLocalStorage();
}

function updatePlayerList() {
  const container = document.getElementById("playerList");
  container.innerHTML = "<b>참가자 목록:</b><br>";
  players.forEach((p, i) => {
    container.innerHTML += `
      <div class="player-item">
        ${p.name} (${skillToGrade(p.skill)}, ${p.gender}) - ${playerGameCounts[p.name] || 0} 경기
        <button class="btn-sm" onclick="removePlayer(${i})">❌ 삭제</button>
      </div>`;
  });
}

function removePlayer(index) {
  const removed = players.splice(index, 1)[0];
  delete playerGameCounts[removed.name];
  updatePlayerList();
  updateMatchList(); // 혹시 해당 선수가 포함된 경기 있으면 반영
}

function clearMatches() {
  matches = [];
  finalizedMatches = [];
  for (const p of players) {
    playerGameCounts[p.name] = 0;
  }
  updatePlayerList();
  updateMatchList();
saveToLocalStorage();
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function generateMatches() {
  const maxGames = parseInt(document.getElementById("maxGames").value) || 3;
  const maxDiff = parseInt(document.getElementById("maxDiff").value) || 1;

  matches = [];
  let usedPairs = new Set();
  let recentPlayers = new Set();  // ✅ 추가

  let sortedPlayers = [...players];
  shuffle(sortedPlayers);
  sortedPlayers.sort((a, b) => (playerGameCounts[a.name] || 0) - (playerGameCounts[b.name] || 0));


  for (let a = 0; a < sortedPlayers.length; a++) {
    for (let b = a + 1; b < sortedPlayers.length; b++) {
      for (let c = b + 1; c < sortedPlayers.length; c++) {
        for (let d = c + 1; d < sortedPlayers.length; d++) {
          const group = [sortedPlayers[a], sortedPlayers[b], sortedPlayers[c], sortedPlayers[d]];

          // ✅ 연속 출전 방지
          if (group.some(p => recentPlayers.has(p.name))) continue;

          // ✅ 최대 경기 수 제한
          if (group.some(p => playerGameCounts[p.name] >= maxGames)) continue;

          // ✅ 실력차 필터
          const skills = group.map(p => p.skill);
          const maxSkill = Math.max(...skills);
          const minSkill = Math.min(...skills);
          if (maxSkill - minSkill > maxDiff) continue;

          const team1 = [group[0], group[1]];
          const team2 = [group[2], group[3]];

          const keys = [team1.map(p => p.name).sort().join("-"), team2.map(p => p.name).sort().join("-")];
          if (keys.some(k => usedPairs.has(k))) continue;

          matches.push({ team1, team2 });
          keys.forEach(k => usedPairs.add(k));

          // ✅ recentPlayers 갱신 (최대 8명 유지)
          group.forEach(p => recentPlayers.add(p.name));
          if (recentPlayers.size > 8) {
            recentPlayers = new Set([...recentPlayers].slice(-8));
          }

          if (matches.length > 100) break;
        }
      }
    }
  }

  updatePlayerList();
  updateMatchList();
saveToLocalStorage();
}

function finalizeMatch(index) {
  const match = matches[index];

  // 수동으로 선택된 선수 이름 가져오기
  const getPlayerFromSelect = (id) => {
    const name = document.getElementById(id).value;
    return players.find(p => p.name === name);
  };

  const p1 = getPlayerFromSelect(`team1_0_${index}`);
  const p2 = getPlayerFromSelect(`team1_1_${index}`);
  const p3 = getPlayerFromSelect(`team2_0_${index}`);
  const p4 = getPlayerFromSelect(`team2_1_${index}`);

  // 선수별 경기 수 증가
  [p1, p2, p3, p4].forEach(p => {
    if (p) {
      playerGameCounts[p.name] = (playerGameCounts[p.name] || 0) + 1;
    }
  });

  // finalizedMatches에 저장
  finalizedMatches.push({ team1: [p1, p2], team2: [p3, p4] });

  // 해당 경기 삭제
  matches.splice(index, 1);

  updatePlayerList();
  updateMatchList();
saveToLocalStorage();
}

function updateMatchList() {
  const container = document.getElementById("matchList");
  const result = document.getElementById("result");
  container.innerHTML = "<b>경기 목록:</b><br>";
  result.value = "";

  matches.forEach((m, idx) => {
    const selectedNames = [];

    // 선택된 기본 값
    const t1p1 = m.team1[0];
    selectedNames.push(t1p1.name);

    const t1p2 = m.team1[1];
    selectedNames.push(t1p2.name);

    const t2p1 = m.team2[0];
    selectedNames.push(t2p1.name);

    const t2p2 = m.team2[1];
    selectedNames.push(t2p2.name);

    container.innerHTML += `
    <div class="match-item">
      ${idx+1}경기: 
      ${playerSelect("team1_0_" + idx, t1p1, selectedNames.filter(n => n !== t1p1.name))} 
      ${playerSelect("team1_1_" + idx, t1p2, selectedNames.filter(n => n !== t1p2.name))} 
      vs 
      ${playerSelect("team2_0_" + idx, t2p1, selectedNames.filter(n => n !== t2p1.name))} 
      ${playerSelect("team2_1_" + idx, t2p2, selectedNames.filter(n => n !== t2p2.name))} 
      <button class="btn-sm" onclick="finalizeMatch(${idx})">✔️ 완료</button>
      <button class="btn-sm" onclick="matches.splice(${idx},1); updateMatchList();">❌ 삭제</button>
    </div>`;
    
    result.value += `${idx+1}경기: ${t1p1.name}, ${t1p2.name} vs ${t2p1.name}, ${t2p2.name}\n`;
  });
}

function playerSelect(id, selected, excludedNames = []) {
  return `
    <select id="${id}" onchange="updateDependentSelects(${id.split('_')[2]})">
      ${players
        .filter(p => !excludedNames.includes(p.name))
        .map(p => `<option value="${p.name}" ${p.name === selected.name ? "selected" : ""}>
          ${p.name} (${skillToGrade(p.skill)}, ${p.gender})
        </option>`).join("")}
    </select>`;
}

function resetAll() {
  if (!confirm("정말 모든 데이터를 초기화할까요? 복구할 수 없습니다.")) return;

  players = [];
  matches = [];
  finalizedMatches = [];
  playerGameCounts = {};

  localStorage.clear();  // 저장된 데이터도 삭제

  updatePlayerList();
  updateMatchList();
  document.getElementById("result").value = "";
}

window.onload = () => {
  loadFromLocalStorage();
  updatePlayerList();
  updateMatchList();
};
</script>
</body>
</html>
