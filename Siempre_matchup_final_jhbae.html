
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Siempre ëŒ€ì§„í‘œ ìƒì„±</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 5px; }
    textarea { width: 100%; height: 300px; margin-top: 20px; white-space: pre-wrap; }
    .player-item, .match-item { margin-bottom: 5px; }
    .btn-sm { font-size: 0.8em; padding: 2px 6px; }
  </style>
</head>
<body>
  <h2>ğŸ¸ Siempre ëŒ€ì§„í‘œ ìƒì„±</h2>

  <label>ì´ë¦„: <input type="text" id="nameInput" /></label>
  <label>ì‹¤ë ¥:
    <select id="skillInput">
      <option value="0">0 (ì´ˆì‹¬)</option>
      <option value="1" selected>1 (E)</option>
      <option value="2">2 (D)</option>
      <option value="3">3 (C)</option>
      <option value="4">4 (B)</option>
      <option value="5">5 (A)</option>
    </select>
  </label>
  <label>ì„±ë³„:
    <select id="genderInput">
      <option value="ë‚¨">ë‚¨</option>
      <option value="ì—¬">ì—¬</option>
    </select>
  </label>
  <button onclick="addPlayer()">ì¶”ê°€</button>

  <div id="playerList"></div>

  <label>ê²Œì„ ìˆ˜ ì œí•œ (ì¸ë‹¹): <input type="number" id="maxGames" value="3" min="1" /></label>
  <label>ìµœëŒ€ ì‹¤ë ¥ì°¨: <input type="number" id="maxDiff" value="1" min="0" /></label>
  <br>
  <button onclick="generateMatches()">ëŒ€ì§„í‘œ ìƒì„±</button>
  <button onclick="clearMatches()">ëª¨ë“  ê²½ê¸° ì‚­ì œ</button>

  <div id="matchList"></div>
  <textarea id="result" readonly></textarea>

<script>
let players = [];
let matches = [];
let finalizedMatches = [];
let playerGameCounts = {};

function skillToGrade(score) {
  return {0: "ì´ˆì‹¬", 1: "E", 2: "D", 3: "C", 4: "B", 5: "A"}[score] || "?";
}

function addPlayer() {
  const name = document.getElementById("nameInput").value.trim();
  const skill = parseInt(document.getElementById("skillInput").value);
  const gender = document.getElementById("genderInput").value;
  if (!name || isNaN(skill)) {
    alert("ì…ë ¥ì„ í™•ì¸í•˜ì„¸ìš”.");
    return;
  }
  players.push({ name, skill, gender });
  playerGameCounts[name] = 0;
  document.getElementById("nameInput").value = "";
  updatePlayerList();
}

function updatePlayerList() {
  const container = document.getElementById("playerList");
  container.innerHTML = "<b>ì°¸ê°€ì ëª©ë¡:</b><br>";
  players.forEach((p, i) => {
    container.innerHTML += `
      <div class="player-item">
        ${p.name} (${skillToGrade(p.skill)}, ${p.gender}) - ${playerGameCounts[p.name] || 0} ê²½ê¸°
        <button class="btn-sm" onclick="removePlayer(${i})">âŒ ì‚­ì œ</button>
      </div>`;
  });
}

function removePlayer(index) {
  const removed = players.splice(index, 1)[0];
  delete playerGameCounts[removed.name];
  updatePlayerList();
  updateMatchList(); // í˜¹ì‹œ í•´ë‹¹ ì„ ìˆ˜ê°€ í¬í•¨ëœ ê²½ê¸° ìˆìœ¼ë©´ ë°˜ì˜
}

function clearMatches() {
  matches = [];
  finalizedMatches = [];
  for (const p of players) {
    playerGameCounts[p.name] = 0;
  }
  updatePlayerList();
  updateMatchList();
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function generateMatches() {
  const maxGames = parseInt(document.getElementById("maxGames").value) || 3;
  const maxDiff = parseInt(document.getElementById("maxDiff").value) || 1;

  matches = [];
  let usedPairs = new Set();
  let recentPlayers = new Set();  // âœ… ì¶”ê°€

  let sortedPlayers = [...players];
  shuffle(sortedPlayers);
  sortedPlayers.sort((a, b) => (playerGameCounts[a.name] || 0) - (playerGameCounts[b.name] || 0));


  for (let a = 0; a < sortedPlayers.length; a++) {
    for (let b = a + 1; b < sortedPlayers.length; b++) {
      for (let c = b + 1; c < sortedPlayers.length; c++) {
        for (let d = c + 1; d < sortedPlayers.length; d++) {
          const group = [sortedPlayers[a], sortedPlayers[b], sortedPlayers[c], sortedPlayers[d]];

          // âœ… ì—°ì† ì¶œì „ ë°©ì§€
          if (group.some(p => recentPlayers.has(p.name))) continue;

          // âœ… ìµœëŒ€ ê²½ê¸° ìˆ˜ ì œí•œ
          if (group.some(p => playerGameCounts[p.name] >= maxGames)) continue;

          // âœ… ì‹¤ë ¥ì°¨ í•„í„°
          const skills = group.map(p => p.skill);
          const maxSkill = Math.max(...skills);
          const minSkill = Math.min(...skills);
          if (maxSkill - minSkill > maxDiff) continue;

          const team1 = [group[0], group[1]];
          const team2 = [group[2], group[3]];

          const keys = [team1.map(p => p.name).sort().join("-"), team2.map(p => p.name).sort().join("-")];
          if (keys.some(k => usedPairs.has(k))) continue;

          matches.push({ team1, team2 });
          keys.forEach(k => usedPairs.add(k));

          // âœ… recentPlayers ê°±ì‹  (ìµœëŒ€ 8ëª… ìœ ì§€)
          group.forEach(p => recentPlayers.add(p.name));
          if (recentPlayers.size > 8) {
            recentPlayers = new Set([...recentPlayers].slice(-8));
          }

          if (matches.length > 100) break;
        }
      }
    }
  }

  updatePlayerList();
  updateMatchList();
}

function finalizeMatch(index) {
  const match = matches[index];
  [...match.team1, ...match.team2].forEach(p => {
    playerGameCounts[p.name] = (playerGameCounts[p.name] || 0) + 1;
  });
  finalizedMatches.push(match);
  matches.splice(index, 1);
  updatePlayerList();
  updateMatchList();
}

function updateMatchList() {
  const container = document.getElementById("matchList");
  const result = document.getElementById("result");
  container.innerHTML = "<b>ê²½ê¸° ëª©ë¡:</b><br>";
  result.value = "";
  matches.forEach((m, idx) => {
    container.innerHTML += `
    <div class="match-item">
      ${idx+1}ê²½ê¸°: 
      ${playerSelect("team1_0_"+idx, m.team1[0])} 
      ${playerSelect("team1_1_"+idx, m.team1[1])}
       vs 
      ${playerSelect("team2_0_"+idx, m.team2[0])} 
      ${playerSelect("team2_1_"+idx, m.team2[1])}
      <button class="btn-sm" onclick="finalizeMatch(${idx})">âœ”ï¸ ì™„ë£Œ</button>
      <button class="btn-sm" onclick="matches.splice(${idx},1); updateMatchList();">âŒ ì‚­ì œ</button>
    </div>`;
    result.value += `${idx+1}ê²½ê¸°: ${m.team1[0].name}, ${m.team1[1].name} vs ${m.team2[0].name}, ${m.team2[1].name}
`;
  });
}

function playerSelect(id, selected) {
  return `
  <select id="${id}">
    ${players.map(p => `<option value="${p.name}" ${p.name === selected.name ? "selected" : ""}>
      ${p.name} (${skillToGrade(p.skill)}, ${p.gender})
    </option>`).join("")}
  </select>`;
}
</script>
</body>
</html>
